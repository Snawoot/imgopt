#!/usr/bin/env python

import sys
import ConfigParser
import os
import os.path
import subprocess
import logging
import json

GLOBAL = "global"
app_root = os.path.dirname(os.path.realpath(__file__))
cfg_defaults = {
    "jpegoptim" :   "/usr/bin/jpegoptim",
    "optipng"   :   "/usr/bin/optipng",
    "log"       :   "stderr",
    "threads"   :   8,
}

ext_format = {
    "jpg"   :   "jpeg",
    "jpeg"  :   "jpeg",
    "jpe"   :   "jpeg",
    "jfif"  :   "jpeg",
    "jif"   :   "jpeg",
    "png"   :   "png",
}

threads = cfg_defaults["threads"]

def prepare_logfile(logname):
    if logname == "stdout":
        return sys.stdout
    elif logname == "stderr":
        return sys.stderr
    else:
        return open(logname, "a")

def setup_logger(logfile):
    logger = logging.getLogger("imgopt")
    logger.setLevel(logging.INFO)
    log_handler = logging.StreamHandler(logfile)
    log_handler.setFormatter(logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s'))
    logger.addHandler(log_handler)
    return logger

def process_image(img_file):
    log.debug("Processing %s", repr(img_file))
    return 0, 0

def optimize_imagedir(path):
    oldsize, newsize, count = 0, 0, 0
    log.info("Processing directory \"%s\"...", path)
    for dp, dn, fn in os.walk(path):
        for filename in fn:
            if os.path.splitext(filename)[1][1:].lower() in ext_format:
                size_before, size_after = process_image(os.path.join(dp, filename))
                oldsize += size_before
                newsize += size_after
                count += 1
    return oldsize, newsize, count

def main():
    global log
    global threads
    cfgpath = os.path.join(app_root, "imgopt.ini")

    config = ConfigParser.RawConfigParser(cfg_defaults)
    configs = config.read(cfgpath)
    assert configs, "No config files read"
    sections = [ s for s in config.sections() if s != GLOBAL ]

    log = setup_logger(prepare_logfile(config.get(GLOBAL, "log")))
    log.info("Starting")
    threads = config.getint(GLOBAL, "threads")

    report = dict()
    for sect in sections:
        try:
            path = config.get(sect, "path")
        except ConfigParser.NoOptionError:
            log.warn("Config section \"%s\" has no \"path\" value specified! Skipping...", sect)
            continue

        if not os.path.isdir(path):
            log.warn("Config section \"%s\": \"path\" value %s doesn`t points to a directory! Skipping...", sect, repr(path))
            continue
        oldsize, newsize, count = optimize_imagedir(path)
        report[sect] = {
            "path": path,
            "count": count,
            "oldsize": oldsize,
            "newsize": newsize,
        }

    json.dump(report, sys.stdout)

if __name__ == '__main__':
    main()
